<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Pac-Man Ultimate iPhone</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<style>
body { background:black; color:white; text-align:center; font-family:sans-serif; margin:0; }
canvas { background:black; display:block; margin:auto; max-width:100vw; height:auto; }
button { font-size:24px; padding:10px; margin:5px; }
</style>
</head>
<body>

<h2>üü° Pac-Man Ultimate+</h2>
<p>Pfeiltasten | R = Neustart | M = Musik</p>
<canvas id="game" width="600" height="360"></canvas>

<div>
<button onclick="moveDir(0,-1)">‚¨ÜÔ∏è</button><br>
<button onclick="moveDir(-1,0)">‚¨ÖÔ∏è</button>
<button onclick="moveDir(1,0)">‚û°Ô∏è</button><br>
<button onclick="moveDir(0,1)">‚¨áÔ∏è</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const tile = 20;

// ================= AUDIO =================
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
let musicOn = true;
let music = null;
function sound(f,d){
 const o=audioCtx.createOscillator(), g=audioCtx.createGain();
 o.frequency.value=f; o.type="square"; g.gain.value=0.1;
 o.connect(g); g.connect(audioCtx.destination);
 o.start(); o.stop(audioCtx.currentTime+d);
}
function startMusic(){
 if(music || !musicOn) return;
 music = audioCtx.createOscillator();
 const g = audioCtx.createGain();
 music.type="sine"; music.frequency.value=170; g.gain.value=0.03;
 music.connect(g); g.connect(audioCtx.destination);
 music.start();
}
function stopMusic(){ if(music){music.stop(); music=null;} }

// ================= MAP =================
const baseMap = [
"1111111111111111111111111111",
"1P000000000000000000000000P1",
"1011110111110111110111111101",
"1000000100000100000100000001",
"1011110111110111110111111101",
"1000000000000000000000000001",
"1011110111110111110111111101",
"1000000100000100000100000001",
"1P000000000000000000000000P1",
"1111111111111111111111111111"
];

// ================= GAME STATE =================
let map, player, ghosts;
let lives, score, level, powerTime;
let totalDots;
let highscore = localStorage.getItem("pacmanHighscore") || 0;

// ================= RESET =================
function resetGame(full=true){
 if(full){ score = 0; level = 1; }
 lives = 3; powerTime = 0;
 map = baseMap.map(r=>r);
 totalDots = map.join("").split("0").length - 1;
 player = { x:1, y:1 };
 ghosts = [];
 for(let i=0;i<level+1;i++){
   ghosts.push({
     x:26, y:5,
     color:["red","pink","cyan","orange"][i%4],
     type:["chase","ambush","random","shy"][i%4]
   });
 }
}
resetGame(true);

// ================= INPUT =================
let keys = {};
document.addEventListener("keydown",e=>{
 keys[e.key]=true;
 audioCtx.resume();
 startMusic();
 if(e.key==="r"||e.key==="R") resetGame(true);
 if(e.key==="m"||e.key==="M"){
   musicOn=!musicOn;
   musicOn?startMusic():stopMusic();
 }
});
document.addEventListener("keyup",e=>keys[e.key]=false);

// ================= TOUCH =================
let nextMove={x:0,y:0};
function moveDir(x,y){ nextMove={x,y}; }

// ================= DRAW =================
function drawMap(){
 for(let y=0;y<map.length;y++)
 for(let x=0;x<map[y].length;x++){
  if(map[y][x]==="1"){ ctx.fillStyle="blue"; ctx.fillRect(x*tile,y*tile,tile,tile); }
  if(map[y][x]==="0"){ ctx.fillStyle="orange"; ctx.beginPath(); ctx.arc(x*tile+10,y*tile+10,3,0,Math.PI*2); ctx.fill(); }
  if(map[y][x]==="P"){ ctx.fillStyle="white"; ctx.beginPath(); ctx.arc(x*tile+10,y*tile+10,6,0,Math.PI*2); ctx.fill(); }
 }
}

// ================= PLAYER =================
function movePlayer(dx,dy){
 let nx=player.x+dx, ny=player.y+dy;
 if(map[ny][nx]!=="1"){
  player.x=nx; player.y=ny;
  if(map[ny][nx]==="0"){
   map[ny]=map[ny].substring(0,nx)+" "+map[ny].substring(nx+1);
   score+=10; sound(800,0.1);
   if(score>highscore){ highscore=score; localStorage.setItem("pacmanHighscore",highscore); }
   totalDots--;
   if(totalDots<=0){ sound(1200,1); level++; resetGame(false); }
  }
  if(map[ny][nx]==="P"){ map[ny]=map[ny].substring(0,nx)+" "+map[ny].substring(nx+1); powerTime=80; sound(400,0.5); }
 }
}

// ================= GHOST AI =================
function moveGhosts(){
 ghosts.forEach(g=>{
  let dx=player.x-g.x, dy=player.y-g.y;
  let mx=0,my=0;
  if(powerTime>0){ mx=-Math.sign(dx); my=-Math.sign(dy); }
  else if(g.type==="chase"){ mx=Math.sign(dx); my=Math.sign(dy); }
  else if(g.type==="ambush"){ mx=Math.sign(dx+1); my=Math.sign(dy+1); }
  else if(g.type==="random"){ [mx,my]=[[1,0],[-1,0],[0,1],[0,-1]][Math.floor(Math.random()*4)]; }
  else if(g.type==="shy"){ if(Math.abs(dx)+Math.abs(dy)<6){ mx=-Math.sign(dx); my=-Math.sign(dy); } }
  if(map[g.y+my][g.x+mx]!=="1"){ g.x+=mx; g.y+=my; }
 });
}

// ================= COLLISION =================
function check(){
 ghosts.forEach(g=>{
  if(g.x===player.x&&g.y===player.y){
   if(powerTime>0){ g.x=26; g.y=5; sound(1000,0.3); }
   else { lives--; sound(200,0.4); player.x=1; player.y=1; }
  }
 });
}

// ================= LOOP =================
function loop(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 if(lives<=0){ ctx.fillStyle="red"; ctx.font="28px Arial"; ctx.fillText("GAME OVER ‚Äì R f√ºr Neustart",50,180); return; }

 drawMap();
 ctx.fillStyle="yellow"; ctx.beginPath(); ctx.arc(player.x*tile+10,player.y*tile+10,8,0,Math.PI*2); ctx.fill();
 ghosts.forEach(g=>{ ctx.fillStyle=powerTime>0?"blue":g.color; ctx.beginPath(); ctx.arc(g.x*tile+10,g.y*tile+10,8,0,Math.PI*2); ctx.fill(); });

 ctx.fillStyle="white"; ctx.fillText("Score: "+score,10,15);
 ctx.fillText("Highscore: "+highscore,220,15);
 ctx.fillText("Level: "+level,520,15);

 if(keys["ArrowUp"]||nextMove.y<0) movePlayer(0,-1);
 if(keys["ArrowDown"]||nextMove.y>0) movePlayer(0,1);
 if(keys["ArrowLeft"]||nextMove.x<0) movePlayer(-1,0);
 if(keys["ArrowRight"]||nextMove.x>0) movePlayer(1,0);
 nextMove={x:0,y:0};

 moveGhosts(); check();
 if(powerTime>0) powerTime--;
 setTimeout(loop,120 - Math.min(level*5,60));
}

loop();
</script>
</body>
</html>
